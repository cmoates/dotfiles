#!/usr/bin/env python3
import requests
import sys
import os

def add_task():
    # Defensive check for environment variables
    token = os.getenv("VIKUNJA_TOKEN")
    url = os.path.join(os.getenv("VIKUNJA_URL", ""), "projects", os.getenv("VIKUNJA_INBOX_ID", "1"), "tasks")
    
    if not token or not os.getenv("VIKUNJA_URL"):
        print("❌ Error: VIKUNJA_TOKEN or VIKUNJA_URL not set. Check your shell environment.")
        sys.exit(1)

    task_text = " ".join(sys.argv[1:])
    if not task_text:
        print("Usage: addtask [task description]")
        sys.exit(1)

    try:
        headers = {"Authorization": f"Bearer {token}"}
        payload = {"title": task_text}
        r = requests.put(url, json=payload, headers=headers, timeout=10)
        
        if r.status_code == 201:
            print(f"✅ Captured: {task_text}")
        else:
            print(f"❌ API Error {r.status_code}: {r.text}")
    except Exception as e:
        print(f"❌ Connection Error: {e}")

if __name__ == "__main__":
    add_task()
